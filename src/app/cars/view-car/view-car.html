
<button type="button" class="btn btn-outline-primary go-back-btn" [routerLink]="['/main-cars']" [queryParams]="{ page: returnPage }"> Zamknij</button>
<div class="container mt-4 flex-wrap">
  <div *ngIf="isLoading" class="full-spinner-overlay">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="card" >
    <div *ngIf="isLoading" class="spinner-overlay">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
      <div [class.opacity-50]="isLoading">Marka: <b>{{car?.brand}}</b></div>
      <div [class.opacity-50]="isLoading">Model: <b>{{car?.model}}</b></div>
      <div [class.opacity-50]="isLoading">Cena: <b>{{car?.price}} zł/12h</b></div>
      <div [class.opacity-50]="isLoading">Identyfikator Pojazdu: <b>#{{car?.id}}</b></div>
      <div class="menage-buttons">
        <button class="btn btn-outline-warning" (click)="openModal('modify', $event,  car)">Modyfikuj</button>
        <button class="btn btn-outline-danger" (click)="delCar(car.id, $event)">Usuń</button>
      </div>
  </div>
  <div class="card image position-relative">
      <div class="image-wrapper position-relative">
        <div *ngIf="isLoadingImage" class="spinner-overlay">
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <img 
          [src]="carsService.getImageUrl(car?.photo)" 
          alt="Car image"
          class="img-fluid"
          style="width: 100%; height: 100%; object-fit: cover; background: #181818;"
          loading="lazy"
          decoding="async"
          (load)="onImageLoad()"
          (error)="onImageError($event)"
          [class.invisible]="isLoadingImage">
      </div>
  </div>

  <div class="card rentals">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Terminy wypożyczeń</h5>
      <button class="btn btn-outline-light btn-sm" type="button" (click)="startAddRental()">
        {{ editingRental ? 'Nowy termin' : 'Dodaj termin' }}
      </button>
    </div>

    <div *ngIf="rentalsLoading" class="text-muted small">Ładowanie terminów...</div>
    <div *ngIf="!rentalsLoading && rentals.length === 0" class="text-muted small">Brak zapisanych wypożyczeń dla tego auta.</div>

    <div class="list-group border-0" *ngIf="rentals.length">
      <div class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center px-0" *ngFor="let rent of rentals">
        <div>
          <div class="fw-semibold">
            {{ rent.startDate }} {{ rent.startTime }} → {{ rent.endDate }} {{ rent.endTime }}
          </div>
        </div>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-warning" (click)="editRental(rent)">Edytuj</button>
          <button class="btn btn-outline-danger" (click)="deleteRental(rent)">Usuń</button>
        </div>
      </div>
    </div>

    <form class="rent-form row g-3 mt-2" [formGroup]="rentForm" (ngSubmit)="saveRental()">
      <div class="col-12 col-md-3">
        <label class="form-label text-secondary small">Data rozpoczęcia</label>
         <input type="date" class="form-control" formControlName="startDate"
           (change)="rentForm.patchValue({ endDate: (rentForm.value.endDate && rentForm.value.endDate < rentForm.value.startDate) ? rentForm.value.startDate : rentForm.value.endDate })">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label text-secondary small">Godzina rozpoczęcia</label>
         <input type="time" class="form-control" formControlName="startTime"
           (change)="onRentStartTimeChange()">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label text-secondary small">Data zakończenia</label>
         <input type="date" class="form-control" formControlName="endDate"
           [min]="rentForm.value.startDate || null">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label text-secondary small">Godzina zakończenia</label>
         <input type="time" class="form-control" formControlName="endTime"
           [min]="(rentForm.value.startDate && rentForm.value.endDate === rentForm.value.startDate) ? (rentForm.value.startTime || '00:00') : null">
      </div>
      <div class="col-12 d-flex flex-wrap align-items-end gap-2">
        <button class="btn btn-success flex-grow-1" type="submit" [disabled]="isRentSaving">
          {{ editingRental ? 'Zapisz zmiany' : 'Dodaj termin' }}
        </button>
        <button class="btn btn-outline-secondary" type="button" *ngIf="editingRental" (click)="cancelRentalEdit()">Anuluj</button>
      </div>
    </form>

    <div *ngIf="rentError" class="text-danger small mt-2">{{ rentError }}</div>
  </div>
</div>